---
title: JVM笔记-内存模型
comments: true
date: 2018-06-18 21:33:45
updated: 2018-06-18 21:33:45
tags:
- JVM
- 内存模型
categories:
- JVM

---

# 运行时数据区划分
- 程序计数器
- 方法区
- 栈
	- 虚拟机栈
	- 本地方法栈
- 堆

# 各区域要点

## 程序计数器

线程私有，当前线程所执行的字节码的指令指示器。

## 方法区

线程共享，存储已被虚拟机加载的类信息、常量、静态变量、编译后的代码等数据,是堆的一个逻辑部分，常量池是方法区的一部分。由于方法区的对象回收较为严格，一般回收算法有别于堆区，不同版本虚拟机实现不同。通过MaxPermSize 设置最大方法区容量。

## 栈
线程私有，分为虚拟机栈（Java代码栈）和本地方法栈。

虚拟机栈用于描述Java方法执行的内存模型：每个方法在执行的同时都会创建一个栈帧（Stack Frame）用于存储局部变量表、操作数栈、动态链接，每一个方法从调用到返回的过程，就对应一个栈帧在虚拟机占中入栈到出栈过程。局部变量表所需的内存大小在编译期间便确定，在方法执行期间不会改变局部变量表的大小。栈的最大深度受虚拟机允许的最大深度以及线程栈大小限制，可通过-Xss设置。

本地方法栈用于描述本地方法执行的内存模型，Sun HotSpot 虚拟机将本地方法栈和虚拟机栈合并。


## 堆

线程共享，用于存放Java对象实例，在JVM启动时创建，是JVM自动垃圾回收的主要区域。为便于回收有些虚拟机将堆进一步划分成新生代、老年代，采用分代收集算法。可通过-Xmx参数设置最大堆大小，-Xms设置堆初始化大小。

### 对象的内存布局

- 对象头
	- 对象运行时数据： 哈希码、GC分代年龄、线程持有的锁，一般用32位或64位的BitMap结构记录。
	- 类型引用：即对象类元数据对象的引用
- 实例数据：对象字段内容
- 对齐填充

### 对象的访问

- 句柄访问：对象引用中为句柄池中的句柄地址，由句柄指向真实的对象，当对象地址改变是对象引用无感知
- 直接访问：速度快（HotSpot） 



----------------------------------------------------------------------















> 周志明. 深入理解Java虚拟机[M]. 机械工业出版社, 2013.
   

